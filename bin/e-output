#! /bin/bash

if [[ -f "/Volumes/rdisk/ramdisk-id" ]]; then
    OUTPUT_DIR="/Volumes/rdisk/e-output"
else
    OUTPUT_DIR="/tmp/e-output"
fi
mkdir -p "$OUTPUT_DIR"

DT=$(date +%Y-%m%d-%H%M)
OUT="$OUTPUT_DIR"/e-output.${DT}.$$.out
ERR="$OUTPUT_DIR"/e-output.${DT}.$$.err
exit_code=0

if [[ $# -gt 1 && "$1" == "--mode" ]]; then
    echo "-*- $2 -*-" >"$ERR"
    shift
    shift
else
    printf "" >"$ERR"
fi

if [[ $# -gt 1 && "$1" == "--wait" ]]; then
    WAIT="$2"
    shift
    shift
else
    WAIT=120
fi

if [[ $# -lt 1 ]]; then
    cat >"$OUT" 2>>"$ERR"
else
    "$@" >"$OUT" 2>>"$ERR" || exit_code=1
fi
if [[ -s "$ERR" ]]; then
    printf '\n\n=======================================================\n' >> "$ERR"
    cat "$OUT" >> "$ERR"
    rm "$OUT"
else
    mv "$OUT" "$ERR"
fi
~/bin/e "$ERR"
(sleep "$WAIT"; rm "$ERR") &
exit $exit_code
